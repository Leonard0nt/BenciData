{% extends 'components/Layout/base_pages.html' %}
{% load static %}

{% block content_pages %}
<div class="mx-auto max-w-6xl space-y-8">
  <section class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <p class="text-sm font-semibold uppercase tracking-wide text-indigo-600">Servicio en ejecución</p>
        <h1 class="mt-1 text-3xl font-bold text-gray-900">
          Turno {{ shift.code }} · {{ shift.sucursal.name }}
        </h1>
        <p class="mt-2 text-sm text-gray-600">
          Iniciado el {{ service_session.started_at|date:"d \d\e F \d\e Y" }} a las {{ service_session.started_at|date:"H:i" }} hrs.
        </p>
      </div>
      <div class="rounded-lg border border-indigo-100 bg-indigo-50 px-4 py-3 text-sm text-indigo-700 shadow-sm">
        <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600">Presupuesto inicial</p>
        <p class="mt-1 text-2xl font-bold text-indigo-900">
          $ {{ service_session.initial_budget|floatformat:2 }}
        </p>
        <p class="mt-2 text-xs text-indigo-700">Monedas: $ {{ service_session.coins_amount|floatformat:2 }} · Efectivo: $ {{ service_session.cash_amount|floatformat:2 }}</p>
      </div>
    </div>
  </section>

  <section class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-gray-900">Equipo asignado</h2>
        <p class="mt-1 text-sm text-gray-600">Encargado y bomberos disponibles para este servicio.</p>
      </div>
    </div>
    <div class="mt-6 grid gap-6 lg:grid-cols-2">
      <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
        <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Encargado del turno</h3>
        {% with manager=shift.manager %}
          {% if manager %}
            <p class="mt-3 text-base font-semibold text-gray-900">{{ manager.user_FK.get_full_name|default:manager.user_FK.username }}</p>
            {% if manager.position_FK %}
              <p class="text-sm text-gray-600">{{ manager.position_FK.user_position }}</p>
            {% endif %}
          {% else %}
            <p class="mt-3 text-sm text-gray-600">No hay un encargado asignado al turno.</p>
          {% endif %}
        {% endwith %}
      </div>
      <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
        <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Bomberos asignados</h3>
        {% if attendants %}
          <ul class="mt-3 space-y-2">
            {% for attendant in attendants %}
              <li class="flex items-center justify-between gap-3 rounded-md border border-gray-100 bg-white px-3 py-2 text-sm text-gray-700">
                <span class="font-medium text-gray-900">{{ attendant.user_FK.get_full_name|default:attendant.user_FK.username }}</span>
                {% if attendant.position_FK %}
                  <span class="text-xs text-gray-500">{{ attendant.position_FK.user_position }}</span>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="mt-3 text-sm text-gray-600">No hay bomberos asignados a este servicio.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <div class="border-b border-gray-200">
    <nav class="-mb-px flex flex-wrap gap-4" aria-label="Tabs">
      <button
        type="button"
        data-tab-target="tab-caja"
        data-tab-group="service-session"
        class="whitespace-nowrap border-b-2 border-indigo-500 px-1 py-3 text-sm font-medium text-indigo-600"
        aria-controls="tab-caja"
        aria-selected="true"
      >Caja</button>
      <button
        type="button"
        data-tab-target="tab-inventario"
        data-tab-group="service-session"
        class="whitespace-nowrap border-b-2 border-transparent px-1 py-3 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
        aria-controls="tab-inventario"
        aria-selected="false"
      >Inventario</button>
    </nav>
  </div>

  <div
    id="tab-caja"
    class="tab-content mt-8 space-y-6"
    x-data="{ saleModalOpen: false, withdrawModalOpen: false, creditModalOpen: false, firefighterPaymentModalOpen: false, transbankVoucherModalOpen: false, closeSessionModalOpen: false, closeSessionMode: 'numeral' }"
    @keydown.escape.window="saleModalOpen = false; withdrawModalOpen = false; creditModalOpen = false; firefighterPaymentModalOpen = false; transbankVoucherModalOpen = false; closeSessionModalOpen = false"
  >
    <section class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Acciones de caja</h2>
          <p class="mt-1 text-sm text-gray-600">Accede rápidamente a los registros y gestiones más frecuentes del servicio.</p>
        </div>
      </div>

      <div class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <button
          type="button"
          class="flex h-full flex-col justify-between rounded-lg border border-gray-100 bg-gray-50 p-5 text-left transition hover:border-indigo-200 hover:bg-white"
          @click="saleModalOpen = true"
        >
          <div>
            <p class="text-sm font-semibold uppercase tracking-wide text-indigo-600">Caja</p>
            <h3 class="mt-2 text-lg font-semibold text-gray-900">Venta de productos</h3>
            <p class="mt-2 text-sm text-gray-600">Registra la venta de productos realizada durante el servicio.</p>
          </div>
        </button>
        <button
          type="button"
          class="flex h-full flex-col justify-between rounded-lg border border-gray-100 bg-gray-50 p-5 text-left transition hover:border-indigo-200 hover:bg-white"
          @click="withdrawModalOpen = true"
        >
          <div>
            <p class="text-sm font-semibold uppercase tracking-wide text-indigo-600">Caja</p>
            <h3 class="mt-2 text-lg font-semibold text-gray-900">Registro de tiradas</h3>
            <p class="mt-2 text-sm text-gray-600">Ingresa los movimientos de dinero generados en el turno.</p>
          </div>
        </button>
        <button
          type="button"
          class="flex h-full flex-col justify-between rounded-lg border border-gray-100 bg-gray-50 p-5 text-left transition hover:border-indigo-200 hover:bg-white"
          @click="creditModalOpen = true"
        >
          <div>
            <p class="text-sm font-semibold uppercase tracking-wide text-indigo-600">Caja</p>
            <h3 class="mt-2 text-lg font-semibold text-gray-900">Registro venta crédito</h3>
            <p class="mt-2 text-sm text-gray-600">Controla las ventas realizadas a crédito y sus detalles.</p>
          </div>
        </button>
        <button
          type="button"
          class="flex h-full flex-col justify-between rounded-lg border border-gray-100 bg-gray-50 p-5 text-left transition hover:border-indigo-200 hover:bg-white"
          @click="firefighterPaymentModalOpen = true"
        >
          <div>
            <p class="text-sm font-semibold uppercase tracking-wide text-indigo-600">Caja</p>
            <h3 class="mt-2 text-lg font-semibold text-gray-900">Registro pago a bomberos</h3>
            <p class="mt-2 text-sm text-gray-600">Lleva el control de los pagos efectuados a los bomberos durante el turno.</p>
          </div>
        </button>
        <button
          type="button"
          class="flex h-full flex-col justify-between rounded-lg border border-gray-100 bg-gray-50 p-5 text-left transition hover:border-indigo-200 hover:bg-white"
          @click="transbankVoucherModalOpen = true"
        >
          <div>
            <p class="text-sm font-semibold uppercase tracking-wide text-indigo-600">Caja</p>
            <h3 class="mt-2 text-lg font-semibold text-gray-900">Registro vaucher Transbank</h3>
            <p class="mt-2 text-sm text-gray-600">Registra y revisa los comprobantes generados por Transbank.</p>
          </div>
        </button>

        <button
          type="button"
          class="flex h-full flex-col justify-between rounded-lg border border-gray-100 bg-gray-50 p-5 text-left transition hover:border-indigo-200 hover:bg-white {% if service_session_closed %}cursor-not-allowed opacity-60{% endif %}"
          {% if not service_session_closed %}@click="closeSessionModalOpen = true"{% else %}disabled{% endif %}
        >
          <div>
            <p class="text-sm font-semibold uppercase tracking-wide text-indigo-600">Caja</p>
            <h3 class="mt-2 text-lg font-semibold text-gray-900">Cierre de caja</h3>
            <p class="mt-2 text-sm text-gray-600">Finaliza el turno registrando el arqueo y cierre del dinero disponible.</p>
            {% if service_session_closed %}
              <span class="mt-2 inline-flex items-center rounded-full bg-indigo-100 px-2 py-1 text-xs font-semibold text-indigo-700">
                Servicio cerrado
              </span>
            {% endif %}          
          </div>
        </button>
      </div>

      <div class="mt-10 rounded-xl border border-indigo-100 bg-indigo-50/40 p-4 sm:p-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h3 class="text-base font-semibold text-gray-900">Tiradas registradas en el día</h3>
            <p class="mt-1 text-sm text-gray-600">Consulta los movimientos ingresados durante el turno.</p>
          </div>
          <span class="inline-flex items-center rounded-full bg-white px-3 py-1 text-sm font-medium text-indigo-700">
            {{ withdrawals|length }} registro{{ withdrawals|length|pluralize:"s" }}
          </span>
        </div>

        {% if withdrawals %}
          <div class="mt-4 overflow-hidden rounded-lg border border-gray-200">
            <table class="min-w-full w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                  <th scope="col" class="px-4 py-3">Fecha</th>
                  <th scope="col" class="px-4 py-3">Hora</th>
                  <th scope="col" class="px-4 py-3">Encargado</th>
                  <th scope="col" class="px-4 py-3 text-right">Monto</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 bg-white text-sm">
                {% for withdrawal in withdrawals %}
                  <tr>
                    <td class="px-4 py-3 text-gray-700">{{ withdrawal.registered_at|date:"d/m/Y" }}</td>
                    <td class="px-4 py-3 text-gray-700">{{ withdrawal.registered_at|date:"H:i" }}</td>
                    <td class="px-4 py-3 font-medium text-gray-900">
                      {{ withdrawal.responsible.user_FK.get_full_name|default:withdrawal.responsible.user_FK.username }}
                    </td>
                    <td class="px-4 py-3 text-right text-gray-900">$ {{ withdrawal.amount|floatformat:0 }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="mt-4 rounded-lg border border-dashed border-gray-300 bg-white/80 p-4 text-sm text-gray-600">
            Aún no se registran tiradas en este turno. Utiliza el botón "Registro de tiradas" para añadir la primera.
          </div>
        {% endif %}
      </div>

      <div class="mt-10 rounded-xl border border-sky-100 bg-sky-50/40 p-4 sm:p-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h3 class="text-base font-semibold text-gray-900">Vouchers Transbank registrados</h3>
            <p class="mt-1 text-sm text-gray-600">Revisa los vouchers ingresados durante este servicio.</p>
          </div>
          <span class="inline-flex items-center rounded-full bg-white px-3 py-1 text-sm font-medium text-sky-700">
            {{ transbank_vouchers|length }} registro{{ transbank_vouchers|length|pluralize:"s" }}
          </span>
        </div>

        {% if transbank_vouchers %}
          <div class="mt-4 overflow-hidden rounded-lg border border-gray-200">
            <table class="min-w-full w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                  <th scope="col" class="px-4 py-3">Fecha</th>
                  <th scope="col" class="px-4 py-3">Hora</th>
                  <th scope="col" class="px-4 py-3">Encargado</th>
                  <th scope="col" class="px-4 py-3 text-right">Monto total</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 bg-white text-sm">
                {% for voucher in transbank_vouchers %}
                  <tr>
                    <td class="px-4 py-3 text-gray-700">{{ voucher.registered_at|date:"d/m/Y" }}</td>
                  <td class="px-4 py-3 text-gray-700">{{ voucher.registered_at|date:"H:i" }}</td>
                  <td class="px-4 py-3 font-medium text-gray-900">
                    {{ voucher.responsible.user_FK.get_full_name|default:voucher.responsible.user_FK.username }}
                  </td>
                  <td class="px-4 py-3 text-right text-gray-900">$ {{ voucher.total_amount|floatformat:0 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="mt-4 rounded-lg border border-dashed border-gray-300 bg-white/80 p-4 text-sm text-gray-600">
            Aún no se registran vouchers de Transbank en este servicio. Usa el botón "Registro vaucher Transbank" para agregar el primero.
          </div>
        {% endif %}
      </div>

      <div class="mt-10 rounded-xl border border-sky-100 bg-sky-50/50 p-4 sm:p-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h3 class="text-base font-semibold text-gray-900">Informe de lecturas IoT</h3>
            <p class="mt-1 text-sm text-gray-600">Registros recibidos desde las pistolas conectadas a la sucursal.</p>
          </div>
          <span class="inline-flex items-center rounded-full bg-white px-3 py-1 text-sm font-medium text-sky-700">
            {{ iot_dispense_events|length }} lectura{{ iot_dispense_events|length|pluralize:"s" }}
          </span>
        </div>

        {% if iot_dispense_events %}
          <div class="mt-4 overflow-hidden rounded-lg border border-gray-200 bg-white">
            <table class="min-w-full w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                  <th scope="col" class="px-4 py-3">Fecha</th>
                  <th scope="col" class="px-4 py-3">Hora</th>
                  <th scope="col" class="px-4 py-3">Pistola</th>
                  <th scope="col" class="px-4 py-3">Numeral</th>
                  <th scope="col" class="px-4 py-3">Bombero</th>
                  <th scope="col" class="px-4 py-3 text-right">Litros</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 bg-white text-sm">
                {% for event in iot_dispense_events %}
                  <tr>
                    <td class="px-4 py-3 text-gray-700">{{ event.created_at|date:"d/m/Y" }}</td>
                    <td class="px-4 py-3 text-gray-700">{{ event.created_at|date:"H:i" }}</td>
                    <td class="px-4 py-3">
                      <p class="font-medium text-gray-900">Pistola #{{ event.nozzle.number|default:event.pistola|default:"-" }}</p>
                      <p class="text-xs text-gray-500">Código {{ event.nozzle.code|default:event.pistola|default:"N/D" }}</p>
                    </td>
                    <td class="px-4 py-3 text-gray-700">
                      {% if event.fuel_numeral %}
                        Estanque {{ event.fuel_numeral.fuel_inventory.code }} · {{ event.fuel_numeral.slot|default:"-" }}
                      {% elif event.nozzle and event.nozzle.fuel_numeral %}
                        Estanque {{ event.nozzle.fuel_numeral.fuel_inventory.code }} · {{ event.nozzle.fuel_numeral.slot|default:"-" }}
                      {% else %}
                        Sin numeral asociado
                      {% endif %}
                    </td>
                    <td class="px-4 py-3 text-gray-700">
                      {% if event.firefighter %}
                        {{ event.firefighter.user_FK.get_full_name|default:event.firefighter.user_FK.username }}
                      {% else %}
                        UID {{ event.uid }}
                      {% endif %}
                    </td>
                    <td class="px-4 py-3 text-right font-semibold text-gray-900">{{ event.litros|floatformat:2 }} L</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="mt-4 rounded-lg border border-dashed border-gray-300 bg-white/80 p-4 text-sm text-gray-600">
            Aún no se reciben lecturas IoT para este servicio. Cuando las pistolas envíen datos, aparecerán aquí con su código y bombero asociado.
          </div>
        {% endif %}
      </div>

      <div class="mt-10 rounded-xl border border-emerald-100 bg-emerald-50/40 p-4 sm:p-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h3 class="text-base font-semibold text-gray-900">Pagos a bomberos part-time</h3>
            <p class="mt-1 text-sm text-gray-600">Registra y consulta los pagos efectuados a los bomberos de medio tiempo en este servicio.</p>
          </div>
          <span class="inline-flex items-center rounded-full bg-white px-3 py-1 text-sm font-medium text-emerald-700">
            {{ firefighter_payments|length }} registro{{ firefighter_payments|length|pluralize:"s" }}
          </span>
        </div>

        {% if firefighter_payments %}
          <div class="mt-4 overflow-hidden rounded-lg border border-gray-200">
            <table class="min-w-full w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                  <th scope="col" class="px-4 py-3">Bombero</th>
                  <th scope="col" class="px-4 py-3">Fecha</th>
                  <th scope="col" class="px-4 py-3">Hora</th>
                  <th scope="col" class="px-4 py-3 text-right">Monto</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 bg-white text-sm">
                {% for payment in firefighter_payments %}
                  <tr>
                    <td class="px-4 py-3 font-medium text-gray-900">
                      {{ payment.firefighter.user_FK.get_full_name|default:payment.firefighter.user_FK.username }}
                    </td>
                    <td class="px-4 py-3 text-gray-700">{{ payment.registered_at|date:"d/m/Y" }}</td>
                    <td class="px-4 py-3 text-gray-700">{{ payment.registered_at|date:"H:i" }}</td>
                    <td class="px-4 py-3 text-right text-gray-900">$ {{ payment.amount|floatformat:0 }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="mt-4 rounded-lg border border-dashed border-gray-300 bg-white/80 p-4 text-sm text-gray-600">
            Aún no se registran pagos para bomberos part-time en este turno. Usa el botón "Registro pago a bomberos" para agregar el primero.
          </div>
        {% endif %}
      </div>

      <div class="rounded-xl border border-violet-100 bg-violet-50/40 p-4 sm:p-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h3 class="text-base font-semibold text-gray-900">Créditos registrados</h3>
            <p class="mt-1 text-sm text-gray-600">Ventas a crédito ingresadas durante este servicio.</p>
          </div>
          <span class="inline-flex items-center rounded-full bg-white px-3 py-1 text-sm font-medium text-indigo-700">
            {{ credit_sales|length }} registro{{ credit_sales|length|pluralize:"s" }}
          </span>
        </div>

        {% if credit_sales %}
          <div class="mt-4 overflow-hidden rounded-lg border border-gray-200 bg-white">
            <table class="min-w-full w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                  <th scope="col" class="px-4 py-3">Factura</th>
                  <th scope="col" class="px-4 py-3">Cliente</th>
                  <th scope="col" class="px-4 py-3">Combustible</th>
                  <th scope="col" class="px-4 py-3 text-right">Monto</th>
                  <th scope="col" class="px-4 py-3">Responsable</th>
                  <th scope="col" class="px-4 py-3">Fecha</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 bg-white text-sm">
                {% for credit in credit_sales %}
                  <tr>
                    <td class="px-4 py-3 font-medium text-gray-900">{{ credit.invoice_number }}</td>
                    <td class="px-4 py-3 text-gray-700">{{ credit.customer_name }}</td>
                    <td class="px-4 py-3 text-gray-700">{{ credit.fuel_inventory.fuel_type }}</td>
                    <td class="px-4 py-3 text-right text-gray-900">$ {{ credit.amount|floatformat:0 }}</td>
                    <td class="px-4 py-3 text-gray-700">
                      {{ credit.responsible.user_FK.get_full_name|default:credit.responsible.user_FK.username }}
                    </td>
                    <td class="px-4 py-3 text-gray-500">{{ credit.created_at|date:"d/m/Y H:i" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="mt-4 rounded-lg border border-dashed border-gray-300 bg-white/80 p-4 text-sm text-gray-600">
            Aún no se registran ventas a crédito en este servicio. Usa el botón "Registro venta crédito" para crear la primera.
          </div>
        {% endif %}
      </div>
    </section>

    <section class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Informe del servicio</h2>
          <p class="mt-1 text-sm text-gray-600">Resumen de ingresos, egresos y ganancias calculadas con los registros del turno.</p>
        </div>
      </div>

      <div class="mt-6 grid gap-6 lg:grid-cols-2">
        <div class="rounded-lg border border-emerald-100 bg-emerald-50/60 p-4">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-emerald-700">Ingresos del turno</h3>
            <span class="rounded-full bg-white px-3 py-1 text-xs font-semibold text-emerald-800">Ganancias del turno</span>
          </div>
          <dl class="mt-4 space-y-3 text-sm text-emerald-900">
            <div class="flex items-center justify-between">
              <dt>Créditos</dt>
              <dd class="font-semibold">$ {{ turn_profit_components.credit_sales|floatformat:0 }}</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt>Vouchers</dt>
              <dd class="font-semibold">$ {{ turn_profit_components.transbank_vouchers|floatformat:0 }}</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt>Registro de tiradas</dt>
              <dd class="font-semibold">$ {{ turn_profit_components.withdrawals|floatformat:0 }}</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt>Ventas registradas</dt>
              <dd class="font-semibold">$ {{ turn_profit_components.product_sales|floatformat:0 }}</dd>
            </div>
            <div class="flex items-center justify-between border-t border-emerald-100 pt-3 text-base font-semibold">
              <dt>Ganancias del turno</dt>
              <dd class="text-xl">$ {{ turn_profit|floatformat:0 }}</dd>
            </div>
          </dl>
        </div>
{% if not is_common_attendant %}
        <div class="rounded-lg border border-amber-100 bg-amber-50/60 p-4">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-amber-700">Egresos del turno</h3>
            <span class="rounded-full bg-white px-3 py-1 text-xs font-semibold text-amber-800">Ganancias reales</span>
          </div>
          <dl class="mt-4 space-y-3 text-sm text-amber-900">
            <div class="flex items-center justify-between">
              <dt>Valor pagado de combustibles</dt>
              <dd class="font-semibold">$ {{ turn_expenses.fuel_loads|floatformat:0 }}</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt>Pagos a bomberos</dt>
              <dd class="font-semibold">$ {{ turn_expenses.firefighter_payments|floatformat:0 }}</dd>
            </div>
            <div class="flex items-center justify-between">
              <dt>Gasto ingreso stock</dt>
              <dd class="font-semibold">$ {{ turn_expenses.product_loads|floatformat:0 }}</dd>
            </div>
            <div class="flex items-center justify-between border-t border-amber-100 pt-3 text-base font-semibold">
              <dt>Ganancias verdaderas del turno</dt>
              <dd class="text-xl">$ {{ net_turn_profit|floatformat:0 }}</dd>
            </div>
          </dl>
        </div>
      </div>
{% endif %}
    </section>

    <div
      x-cloak
      x-show="saleModalOpen"
      x-transition.opacity
      class="fixed inset-0 z-50 flex justify-center bg-gray-900/80 p-4 sm:items-center"
      @click.self="saleModalOpen = false"
      style="margin-top: 0%;"
    >
      <div
        class="w-full max-w-3xl overflow-y-auto rounded-none bg-white p-6 shadow-2xl sm:max-h-[calc(100vh-3rem)] sm:rounded-xl"
        @click.away="saleModalOpen = false"
      >
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Registrar venta de productos</h3>
            <p class="mt-1 text-sm text-gray-500">Selecciona los productos vendidos y las cantidades entregadas durante el turno.</p>
          </div>
          <button type="button" class="rounded-md p-1 text-gray-400 hover:text-gray-600" @click="saleModalOpen = false">
            <span class="sr-only">Cerrar</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
              <path
                fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>

        <form method="post" action="{% url 'service_session_detail' service_session.pk %}" class="mt-6 space-y-6">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="product-sale" />

          {% if product_sale_form.non_field_errors %}
            <div class="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-700">
              {% for error in product_sale_form.non_field_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}

          {% if product_sale_formset.non_form_errors %}
            <div class="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-700">
              {% for error in product_sale_formset.non_form_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}

          {{ product_sale_formset.management_form }}

          <div class="space-y-4" id="product-sale-items" data-formset-prefix="{{ product_sale_formset.prefix }}">
            {% for form in product_sale_formset %}
              <div class="rounded-lg border border-gray-200 p-4 shadow-sm">
                {{ form.id }}
                {% if form.non_field_errors %}
                  <div class="mb-3 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700">
                    {% for error in form.non_field_errors %}
                      <p>{{ error }}</p>
                    {% endfor %}
                  </div>
                {% endif %}
                <div class="grid gap-4 sm:grid-cols-2">
                  <div>
                    <label for="{{ form.product.id_for_label }}" class="block text-sm font-medium text-gray-700">Producto</label>
                    {{ form.product }}
                    {% if form.product.errors %}
                      <p class="mt-1 text-sm text-red-600">{{ form.product.errors|striptags }}</p>
                    {% endif %}
                  </div>
                  <div>
                    <label for="{{ form.quantity.id_for_label }}" class="block text-sm font-medium text-gray-700">Cantidad vendida</label>
                    {{ form.quantity }}
                    {% if form.quantity.errors %}
                      <p class="mt-1 text-sm text-red-600">{{ form.quantity.errors|striptags }}</p>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
          <button
            type="button"
            id="add-product-sale-item"
            class="mt-4 inline-flex items-center rounded-md border border-dashed border-indigo-300 px-4 py-2 text-sm font-medium text-indigo-700 hover:bg-indigo-50"
          >
            <span class="mr-2 text-lg font-semibold">+</span> Agregar producto
          </button>

          <template id="product-sale-item-template">
            <div class="rounded-lg border border-gray-200 p-4 shadow-sm">
              {{ product_sale_formset.empty_form.id }}
              <div class="grid gap-4 sm:grid-cols-2">
                <div>
                  <label for="{{ product_sale_formset.empty_form.product.id_for_label }}" class="block text-sm font-medium text-gray-700">Producto</label>
                  {{ product_sale_formset.empty_form.product }}
                </div>
                <div>
                  <label for="{{ product_sale_formset.empty_form.quantity.id_for_label }}" class="block text-sm font-medium text-gray-700">Cantidad vendida</label>
                  {{ product_sale_formset.empty_form.quantity }}
                </div>
              </div>
            </div>
          </template>

          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <span class="block text-sm font-medium text-gray-700">Responsable</span>
              {% if product_sale_responsible %}
                <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">
                  {{ product_sale_responsible.user_FK.get_full_name|default:product_sale_responsible.user_FK.username }}
                </p>
              {% else %}
                <p class="mt-2 rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-700">
                  No hay un encargado asignado al turno.
                </p>
              {% endif %}
            </div>
            <div>
              <span class="block text-sm font-medium text-gray-700">Fecha</span>
              <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">{{ service_date|date:"d \d\e F \d\e Y" }}</p>
            </div>
          </div>

          <div class="flex flex-wrap items-center justify-end gap-3">
            <button
              type="button"
              class="inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
              @click="saleModalOpen = false"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="inline-flex items-center rounded-md bg-gradient-to-br px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
            >
              Registrar venta
            </button>
          </div>
          <script>
            document.addEventListener("DOMContentLoaded", () => {
              const addButton = document.getElementById("add-product-sale-item");
              const container = document.getElementById("product-sale-items");
              const template = document.getElementById("product-sale-item-template");
              if (!addButton || !container || !template) {
                return;
              }

              const prefix = container.dataset.formsetPrefix || "form";
              const totalFormsInput = document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);

              addButton.addEventListener("click", () => {
                if (!totalFormsInput) {
                  return;
                }

                const currentCount = parseInt(totalFormsInput.value, 10) || 0;
                const newFormHTML = template.innerHTML.replace(/__prefix__/g, currentCount);
                const fragment = document.createElement("div");
                fragment.innerHTML = newFormHTML.trim();
                const newForm = fragment.firstElementChild;
                if (newForm) {
                  container.appendChild(newForm);
                  totalFormsInput.value = currentCount + 1;
                }
              });
            });
          </script>
        </form>
      </div>
    </div>
    <div
      x-cloak
      x-show="creditModalOpen"
      x-transition.opacity
      class="fixed inset-0 z-50 flex justify-center bg-gray-900/80 p-4 sm:items-center"
      @click.self="creditModalOpen = false"
      style="margin-top: 0%;"
    >
      <div
        class="w-full max-w-2xl overflow-y-auto rounded-none bg-white p-6 shadow-2xl sm:max-h-[calc(100vh-3rem)] sm:rounded-xl"
        @click.away="creditModalOpen = false"
      >
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Registrar venta a crédito</h3>
            <p class="mt-1 text-sm text-gray-500">Completa los datos para dejar registro de la venta diferida.</p>
          </div>
          <button type="button" class="rounded-md p-1 text-gray-400 hover:text-gray-600" @click="creditModalOpen = false">
            <span class="sr-only">Cerrar</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
              <path
                fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>

        <form method="post" action="{% url 'service_session_detail' service_session.pk %}" class="mt-6 space-y-5">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="credit-sale" />

          {% if credit_sale_form.non_field_errors %}
            <div class="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-700">
              {% for error in credit_sale_form.non_field_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}

          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <label for="{{ credit_sale_form.invoice_number.id_for_label }}" class="block text-sm font-medium text-gray-700">N° de factura</label>
              {{ credit_sale_form.invoice_number }}
              {% if credit_sale_form.invoice_number.errors %}
                <p class="mt-1 text-sm text-red-600">{{ credit_sale_form.invoice_number.errors|striptags }}</p>
              {% endif %}
            </div>
            <div>
              <label for="{{ credit_sale_form.customer_name.id_for_label }}" class="block text-sm font-medium text-gray-700">Nombre cliente</label>
              {{ credit_sale_form.customer_name }}
              {% if credit_sale_form.customer_name.errors %}
                <p class="mt-1 text-sm text-red-600">{{ credit_sale_form.customer_name.errors|striptags }}</p>
              {% endif %}
            </div>
          </div>

          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <label for="{{ credit_sale_form.fuel_inventory.id_for_label }}" class="block text-sm font-medium text-gray-700">Tipo de combustible</label>
              {{ credit_sale_form.fuel_inventory }}
              {% if credit_sale_form.fuel_inventory.errors %}
                <p class="mt-1 text-sm text-red-600">{{ credit_sale_form.fuel_inventory.errors|striptags }}</p>
              {% endif %}
            </div>
            <div>
              <label for="{{ credit_sale_form.amount.id_for_label }}" class="block text-sm font-medium text-gray-700">Monto del crédito</label>
              {{ credit_sale_form.amount }}
              {% if credit_sale_form.amount.errors %}
                <p class="mt-1 text-sm text-red-600">{{ credit_sale_form.amount.errors|striptags }}</p>
              {% else %}
                <p class="mt-1 text-xs text-gray-500">Ingresa el monto total de la venta diferida.</p>
              {% endif %}
            </div>
          </div>

          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <span class="block text-sm font-medium text-gray-700">Responsable</span>
              {% if credit_sale_responsible %}
                <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">
                  {{ credit_sale_responsible.user_FK.get_full_name|default:credit_sale_responsible.user_FK.username }}
                </p>
              {% else %}
                <p class="mt-2 rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-700">
                  No hay un perfil asignado para registrar el crédito.
                </p>
              {% endif %}
            </div>
            <div>
              <span class="block text-sm font-medium text-gray-700">Fecha</span>
              <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">{{ service_date|date:"d \d\e F \d\e Y" }}</p>
            </div>
          </div>

          <div class="flex flex-wrap items-center justify-end gap-3">
            <button
              type="button"
              class="inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
              @click="creditModalOpen = false"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="inline-flex items-center rounded-md bg-gradient-to-br px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
            >
              Registrar crédito
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      x-cloak
      x-show="withdrawModalOpen"
      x-transition.opacity
      class="fixed inset-0 z-50 flex justify-center bg-gray-900/80 p-4 sm:items-center"
      @click.self="withdrawModalOpen = false"
      style="margin-top: 0%;"
    >
      <div
        class="w-full max-w-xl overflow-y-auto rounded-none bg-white p-6 shadow-2xl sm:max-h-[calc(100vh-3rem)] sm:rounded-xl"
        @click.away="withdrawModalOpen = false"
      >
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Registrar tirada de caja</h3>
            <p class="mt-1 text-sm text-gray-500">Confirma quién realiza la tirada y el monto entregado en el día.</p>
          </div>
          <button type="button" class="rounded-md p-1 text-gray-400 hover:text-gray-600" @click="withdrawModalOpen = false">
            <span class="sr-only">Cerrar</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
              <path
                fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>

        <form method="post" action="{% url 'service_session_detail' service_session.pk %}" class="mt-6 space-y-5">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="withdrawal" />

          {% if withdraw_form.non_field_errors %}
            <div class="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-700">
              {% for error in withdraw_form.non_field_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}

          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <span class="block text-sm font-medium text-gray-700">Fecha de registro</span>
              <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">
                {{ current_datetime|date:"d \d\e F \d\e Y" }}
              </p>
            </div>
            <div>
              <span class="block text-sm font-medium text-gray-700">Hora</span>
              <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">
                {{ current_datetime|date:"H:i" }} hrs
              </p>
            </div>
            <div class="sm:col-span-2">
              <span class="block text-sm font-medium text-gray-700">Encargado</span>
              {% if withdraw_responsible %}
                <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">
                  {{ withdraw_responsible.user_FK.get_full_name|default:withdraw_responsible.user_FK.username }}
                </p>
              {% else %}
                <p class="mt-2 rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-700">
                  No hay un encargado asignado al turno.
                </p>
              {% endif %}
            </div>
          </div>

          <div>
            <label for="{{ withdraw_form.amount.id_for_label }}" class="block text-sm font-medium text-gray-700">Monto de la tirada</label>
            <div class="mt-1 flex rounded-md shadow-sm">
              <span class="inline-flex items-center rounded-l-md border border-r-0 border-gray-300 bg-gray-50 px-3 text-sm text-gray-500">$</span>
              {{ withdraw_form.amount }}
            </div>
            {% if withdraw_form.amount.errors %}
              <p class="mt-1 text-sm text-red-600">{{ withdraw_form.amount.errors|striptags }}</p>
            {% else %}
              <p class="mt-1 text-xs text-gray-500">Ingresa manualmente el monto entregado por la tirada.</p>
            {% endif %}
          </div>

          <div class="flex flex-wrap items-center justify-end gap-3">
            <button
              type="button"
              class="inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
              @click="withdrawModalOpen = false"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="inline-flex items-center rounded-md bg-gradient-to-br px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
            >
              Registrar tirada
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      x-cloak
      x-show="transbankVoucherModalOpen"
      x-transition.opacity
      class="fixed inset-0 z-50 flex justify-center bg-gray-900/80 p-4 sm:items-center"
      @click.self="transbankVoucherModalOpen = false"
      style="margin-top: 0%;"
    >
      <div
        class="w-full max-w-2xl overflow-y-auto rounded-none bg-white p-6 shadow-2xl sm:max-h-[calc(100vh-3rem)] sm:rounded-xl"
        @click.away="transbankVoucherModalOpen = false"
      >
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Registrar vouchers Transbank</h3>
            <p class="mt-1 text-sm text-gray-500">Ingresa el monto total cobrado en Transbank.</p>
          </div>
          <button type="button" class="rounded-md p-1 text-gray-400 hover:text-gray-600" @click="transbankVoucherModalOpen = false">
            <span class="sr-only">Cerrar</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
              <path
                fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>

        <form method="post" action="{% url 'service_session_detail' service_session.pk %}" class="mt-6 space-y-6">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="transbank-voucher" />

          {% if transbank_voucher_form.non_field_errors %}
            <div class="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-700">
              {% for error in transbank_voucher_form.non_field_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}

          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <span class="block text-sm font-medium text-gray-700">Fecha</span>
              <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">{{ current_datetime|date:"d \d\e F \d\e Y" }}</p>
            </div>
            <div>
              <span class="block text-sm font-medium text-gray-700">Hora</span>
              <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">{{ current_datetime|date:"H:i" }} hrs</p>
            </div>
            <div class="sm:col-span-2">
              <span class="block text-sm font-medium text-gray-700">Encargado</span>
              {% if transbank_voucher_responsible %}
                <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">
                  {{ transbank_voucher_responsible.user_FK.get_full_name|default:transbank_voucher_responsible.user_FK.username }}
                </p>
              {% else %}
                <p class="mt-2 rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-700">
                  No hay un encargado asignado al turno.
                </p>
              {% endif %}
            </div>
          </div>

          <div>
            <label for="{{ transbank_voucher_form.total_amount.id_for_label }}" class="block text-sm font-medium text-gray-700">Monto total</label>
            <div class="mt-1 flex rounded-md shadow-sm">
              <span class="inline-flex items-center rounded-l-md border border-r-0 border-gray-300 bg-gray-50 px-3 text-sm text-gray-500">$</span>
              {{ transbank_voucher_form.total_amount }}
            </div>
            {% if transbank_voucher_form.total_amount.errors %}
              <p class="mt-1 text-sm text-red-600">{{ transbank_voucher_form.total_amount.errors|striptags }}</p>
            {% else %}
              <p class="mt-1 text-xs text-gray-500">Ingresa el monto total cobrado mediante Transbank.</p>
            {% endif %}
          </div>

          <div class="flex flex-wrap items-center justify-end gap-3">
            <button
              type="button"
              class="inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
              @click="transbankVoucherModalOpen = false"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="inline-flex items-center rounded-md bg-gradient-to-br px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
            >
              Registrar vouchers
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      x-cloak
      x-show="firefighterPaymentModalOpen"
      x-transition.opacity
      class="fixed inset-0 z-50 flex justify-center bg-gray-900/80 p-4 sm:items-center"
      @click.self="firefighterPaymentModalOpen = false"
      style="margin-top: 0%;"
    >
      <div
        class="w-full max-w-3xl overflow-y-auto rounded-none bg-white p-6 shadow-2xl sm:max-h-[calc(100vh-3rem)] sm:rounded-xl"
        @click.away="firefighterPaymentModalOpen = false"
      >
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Registrar pago a bomberos</h3>
            <p class="mt-1 text-sm text-gray-500">Ingresa el pago diario para cada bombero part-time asignado al servicio.</p>
          </div>
          <button type="button" class="rounded-md p-1 text-gray-400 hover:text-gray-600" @click="firefighterPaymentModalOpen = false">
            <span class="sr-only">Cerrar</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
              <path
                fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>

        <form method="post" action="{% url 'service_session_detail' service_session.pk %}" class="mt-6 space-y-5">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="firefighter-payment" />

          {% if firefighter_payment_form.non_field_errors %}
            <div class="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-700">
              {% for error in firefighter_payment_form.non_field_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}

          {% if part_time_attendants %}
            <div class="grid gap-4 sm:grid-cols-2">
              <div>
                <span class="block text-sm font-medium text-gray-700">Fecha</span>
                <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">{{ current_datetime|date:"d \d\e F \d\e Y" }}</p>
              </div>
              <div>
                <span class="block text-sm font-medium text-gray-700">Hora</span>
                <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">{{ current_datetime|date:"H:i" }} hrs</p>
              </div>
            </div>

            <div class="mt-4 space-y-4">
              {% for attendant, field in firefighter_payment_fields %}
                <div class="flex flex-col gap-3 rounded-lg border border-gray-200 bg-gray-50 p-4 sm:flex-row sm:items-center sm:justify-between">
                  <div>
                    <p class="text-sm font-semibold text-gray-900">{{ attendant.user_FK.get_full_name|default:attendant.user_FK.username }}</p>
                    {% if attendant.position_FK %}
                      <p class="text-xs text-gray-600">{{ attendant.position_FK.user_position }}</p>
                    {% else %}
                      <p class="text-xs text-gray-500">Bombero part-time</p>
                    {% endif %}
                  </div>
                  <div class="w-full sm:max-w-xs">
                    <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700">Monto a pagar</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                      <span class="inline-flex items-center rounded-l-md border border-r-0 border-gray-300 bg-white px-3 text-sm text-gray-500">$</span>
                      {{ field }}
                    </div>
                    {% if field.errors %}
                      <p class="mt-1 text-sm text-red-600">{{ field.errors|striptags }}</p>
                    {% else %}
                      <p class="mt-1 text-xs text-gray-500">Ingresa el pago correspondiente al día trabajado.</p>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="rounded-md border border-amber-200 bg-amber-50 p-4 text-sm text-amber-700">
              No hay bomberos part-time asignados a este servicio para registrar pagos.
            </div>
          {% endif %}

          <div class="flex flex-wrap items-center justify-end gap-3">
            <button
              type="button"
              class="inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
              @click="firefighterPaymentModalOpen = false"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="inline-flex items-center rounded-md bg-gradient-to-br px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
            >
              Registrar pagos
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <div
      x-cloak
      x-show="closeSessionModalOpen"
      x-transition.opacity
      class="fixed inset-0 z-50 flex justify-center bg-gray-900/80 p-4 sm:items-center"
      @click.self="closeSessionModalOpen = false"
      style="margin-top: 0%;"
    >
      <div
        class="w-full max-w-4xl overflow-y-auto rounded-none bg-white p-6 shadow-2xl sm:max-h-[calc(100vh-3rem)] sm:rounded-xl"
        @click.away="closeSessionModalOpen = false"
      >
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Cierre de caja y servicio</h3>
            <p class="mt-1 text-sm text-gray-500">
              Ingresa el numeral de cada estanque asociado a las máquinas registradas. El valor ingresado se guardará como numeral actualizado del estanque en esa máquina.
            </p>
          </div>
          <button type="button" class="rounded-md p-1 text-gray-400 hover:text-gray-600" @click="closeSessionModalOpen = false">
            <span class="sr-only">Cerrar</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
              <path
                fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
        </div>

        <div class="mt-4 flex flex-wrap items-center justify-between gap-3">
          <div>
            <p class="text-sm font-semibold text-gray-800">Modo de registro</p>
            <p class="text-xs text-gray-500">Alterna entre visualizar numerales por estanque o por pistola.</p>
          </div>
          <div class="inline-flex rounded-md border border-gray-200 bg-gray-50 p-1 text-sm font-medium text-gray-700 shadow-sm">
            <button
              type="button"
              class="rounded-md px-3 py-1 transition"
              :class="closeSessionMode === 'numeral' ? 'bg-white text-indigo-700 shadow-sm' : 'text-gray-600 hover:text-gray-800'"
              @click="closeSessionMode = 'numeral'"
            >Modo numeral</button>
            <button
              type="button"
              class="rounded-md px-3 py-1 transition"
              :class="closeSessionMode === 'pistola' ? 'bg-white text-indigo-700 shadow-sm' : 'text-gray-600 hover:text-gray-800'"
              @click="closeSessionMode = 'pistola'"
            >Modo pistola</button>
          </div>
        </div>

        {% if service_session_closed %}
          <div class="mt-4 rounded-md border border-amber-200 bg-amber-50 p-4 text-sm text-amber-800">
            Este servicio ya se encuentra cerrado. No es posible registrar nuevos numerales.
          </div>
        {% else %}
          <form method="post" action="{% url 'service_session_detail' service_session.pk %}" class="mt-6 space-y-6">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="close-session" />
            {{ service_close_formset.management_form }}

            {% if service_close_formset.non_form_errors %}
              <div class="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-700">
                {% for error in service_close_formset.non_form_errors %}
                  <p>{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}

            <div class="space-y-4">
              <template x-if="closeSessionMode === 'numeral'">
                <div class="space-y-4" x-cloak>
                  {% if machine_inventory_close_groups %}
                    {% for machine, inventories in machine_inventory_close_groups %}
                      <div class="rounded-lg border border-gray-200 p-4 shadow-sm">
                        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                          <div>
                            <p class="text-sm font-semibold text-gray-900">Máquina {{ machine.number }} · Isla {{ machine.island.number }}</p>
                            <p class="mt-1 text-xs text-gray-500">
                              Estanques asociados:
                              {% for inventory, current_numeral, inventory_form in inventories %}
                                {{ inventory.code }}{% if not forloop.last %}, {% endif %}
                              {% endfor %}
                            </p>
                          </div>
                        </div>

                        <div class="mt-4 space-y-4">
                          {% for inventory, current_numeral, form in inventories %}
                            {{ form.machine_id }}
                            {{ form.fuel_inventory_id }}
                            {{ form.slot }}
                            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                              <div>
                                <p class="text-sm font-semibold text-gray-900">Estanque {{ inventory.code }} · {{ inventory.fuel_type }}</p>
                                <p class="mt-1 text-xs text-gray-500">Numeral actual: {{ current_numeral }}</p>
                              </div>
                              <div class="sm:w-64">
                                <label for="{{ form.numeral.id_for_label }}" class="block text-sm font-medium text-gray-700">Numeral</label>
                                {{ form.numeral }}
                                {% if form.numeral.errors %}
                                  <p class="mt-1 text-sm text-red-600">{{ form.numeral.errors|striptags }}</p>
                                {% endif %}
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="rounded-md border border-dashed border-gray-300 bg-gray-50 p-4 text-sm text-gray-600">
                      No hay máquinas registradas en la sucursal para cerrar el servicio.
                    </div>
                  {% endif %}
                </div>
              </template>

              <template x-if="closeSessionMode === 'pistola'">
                <div class="space-y-4" x-cloak>
                  {% if machine_nozzle_close_groups %}
                    {% for machine, inventories in machine_nozzle_close_groups %}
                      <div class="rounded-lg border border-gray-200 p-4 shadow-sm">
                        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                          <div>
                            <p class="text-sm font-semibold text-gray-900">Máquina {{ machine.number }} · Isla {{ machine.island.number }}</p>
                            <p class="mt-1 text-xs text-gray-500">Pistolas registradas: {{ machine.nozzles.all|length }}</p>
                          </div>
                        </div>

                        <div class="mt-4 space-y-4">
                          {% for inventory, current_numeral, form, nozzles in inventories %}
                            {{ form.machine_id }}
                            {{ form.fuel_inventory_id }}
                            {{ form.slot }}
                            <div class="flex flex-col gap-3 rounded-md border border-gray-100 bg-gray-50 p-4 sm:flex-row sm:items-center sm:justify-between">
                              <div class="space-y-1">
                                <p class="text-sm font-semibold text-gray-900">
                                  Pistola{{ nozzles|length|pluralize }}:
                                  {% if nozzles %}
                                    {% for nozzle in nozzles %}
                                      #{{ nozzle.number|default:nozzle.fuel_numeral.slot }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                  {% else %}
                                    Sin pistolas asociadas&nbsp;
                                  {% endif %}
                                </p>
                                <p class="text-xs text-gray-600">Estanque {{ inventory.code }} · {{ inventory.fuel_type }}</p>
                                <p class="text-xs text-gray-500">Numeral actual: {{ current_numeral }}</p>
                              </div>
                              <div class="sm:w-64">
                                <label for="{{ form.numeral.id_for_label }}" class="block text-sm font-medium text-gray-700">Numeral</label>
                                {{ form.numeral }}
                                {% if form.numeral.errors %}
                                  <p class="mt-1 text-sm text-red-600">{{ form.numeral.errors|striptags }}</p>
                                {% endif %}
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="rounded-md border border-dashed border-gray-300 bg-gray-50 p-4 text-sm text-gray-600">
                      No hay pistolas registradas para las máquinas de esta sucursal.
                    </div>
                  {% endif %}
                </div>
              </template>

              {% if close_session_flow_details %}
                <div class="rounded-lg border border-emerald-200 bg-emerald-50 p-4">
                  <div class="flex items-center justify-between gap-3">
                    <div>
                      <p class="text-sm font-semibold text-emerald-900">Flujo real estimado</p>
                      <p class="text-xs text-emerald-800">Calculado con los numerales ingresados para este turno.</p>
                    </div>
                    <div class="rounded-full bg-white px-3 py-1 text-xs font-semibold text-emerald-800">
                      $ {{ close_session_flow_total|default:0|floatformat:0 }}
                    </div>
                  </div>

                  <div class="mt-4 divide-y divide-emerald-100 border-t border-emerald-100 text-sm text-emerald-900">
                    {% for flow in close_session_flow_details %}
                      <div class="flex flex-col gap-2 py-3 sm:flex-row sm:items-center sm:justify-between">
                        <div>
                          <p class="font-semibold">Máquina {{ flow.machine.number }} · Isla {{ flow.machine.island.number }}</p>
                          <p class="text-xs text-emerald-700">Estanque {{ flow.fuel_inventory.code }} · {{ flow.fuel_type|default:"Combustible sin definir" }}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-right sm:w-auto sm:grid-cols-3 sm:text-left">
                          <div>
                            <p class="text-xs text-emerald-700">Litros vendidos</p>
                            <p class="font-semibold">{{ flow.liters_sold|floatformat:2 }} L</p>
                          </div>                          <div>
                            <p class="text-xs text-emerald-700">Precio por litro</p>
                            <p class="font-semibold">
                              {% if flow.price %}
                                $ {{ flow.price|floatformat:0 }}
                              {% else %}
                                No definido
                              {% endif %}
                            </p>
                          </div>
                          <div>
                            <p class="text-xs text-emerald-700">Subtotal</p>
                            <p class="font-semibold">$ {{ flow.flow_amount|floatformat:0 }}</p>
                          </div>

                        </div>

                      </div>
                    {% endfor %}
                  </div>

                  {% if close_session_flow_gap is not None %}
                    <div class="mt-4 rounded-md border border-indigo-100 bg-indigo-50 p-4 text-sm text-indigo-900">
                      <div class="flex items-center justify-between gap-3">
                        <div>
                          <p class="font-semibold">Resultado de descuadre</p>
                          <p class="text-xs text-indigo-700">Flujo estimado menos ingresos del turno.</p>
                        </div>
                        <span class="rounded-full bg-white px-3 py-1 text-xs font-semibold text-indigo-800">
                          {{ close_session_flow_mismatch_label }}
                        </span>
                      </div>
                      <p class="mt-3 text-right text-lg font-semibold">$ {{ close_session_flow_gap|floatformat:0 }}</p>
                    </div>
                  {% endif %}

                  {% if close_session_flow_missing_prices %}
                    <p class="mt-3 text-xs text-amber-700">Faltan precios para: {{ close_session_flow_missing_prices|join:', ' }}.</p>
                  {% endif %}
                </div>
              {% endif %}
            </div>

            <div class="flex flex-wrap items-center justify-end gap-3">
              <button
                type="button"
                class="inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                @click="closeSessionModalOpen = false"
              >
                Cancelar
              </button>
              <button
                type="submit"
                name="close_action"
                value="check"
                class="inline-flex items-center rounded-md border border-indigo-200 bg-white px-4 py-2 text-sm font-semibold text-indigo-700 shadow-sm hover:bg-indigo-50"
              >
                Comprobar flujo
              </button>
              <button
                type="submit"
                name="close_action"
                value="close"
                class="inline-flex items-center rounded-md bg-gradient-to-br px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
              >
                Cerrar servicio
              </button>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  </div>

  <div
    id="tab-inventario"
    class="tab-content mt-8 space-y-6 hidden"
    x-data="{ openModal: null }"
    @keydown.escape.window="openModal = null"
  >
    <section class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Inventario del servicio</h2>
          <p class="mt-1 text-sm text-gray-600">Aquí podrás registrar y revisar el inventario utilizado durante el servicio.</p>
        </div>
        {% if fuel_inventories %}
          <button
            type="button"
            class="inline-flex items-center rounded-md bg-gradient-to-br px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
            @click="openModal = 'fuel-load'"
          >
            Agregar combustible
          </button>
        {% endif %}
      </div>

      {% if fuel_inventories %}
        <div class="mt-6 overflow-hidden rounded-lg border border-gray-200">
          <table class="min-w-full w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                <th scope="col" class="px-4 py-3">Tanque</th>
                <th scope="col" class="px-4 py-3">Tipo de combustible</th>
                <th scope="col" class="px-4 py-3 text-right">Capacidad total (L)</th>
                <th scope="col" class="px-4 py-3 text-right">Cantidad actual (L)</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white text-sm">
              {% for inventory in fuel_inventories %}
                <tr>
                  <td class="px-4 py-3 font-medium text-gray-900">{{ inventory.code }}</td>
                  <td class="px-4 py-3 text-gray-700">{{ inventory.fuel_type }}</td>
                  <td class="px-4 py-3 text-right text-gray-700">{{ inventory.capacity|floatformat:2 }}</td>
                  <td class="px-4 py-3 text-right text-gray-900">{{ inventory.liters|floatformat:2 }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if fuel_loads %}
          <div class="mt-8">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Historial de cargas</h3>
            <div class="mt-3 overflow-hidden rounded-lg border border-gray-200">
              <table class="min-w-full w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                    <th scope="col" class="px-4 py-3">Fecha</th>
                    <th scope="col" class="px-4 py-3">Tanque</th>
                    <th scope="col" class="px-4 py-3">Litros cargados</th>
                    <th scope="col" class="px-4 py-3">Valor pagado</th>
                    <th scope="col" class="px-4 py-3">Factura</th>
                    <th scope="col" class="px-4 py-3">Chofer</th>
                    <th scope="col" class="px-4 py-3">Patente</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white text-sm">
                  {% for fuel_load in fuel_loads %}
                    <tr>
                      <td class="px-4 py-3 text-gray-700">{{ fuel_load.date|date:"d/m/Y" }}</td>
                      <td class="px-4 py-3 font-medium text-gray-900">{{ fuel_load.inventory.code }}</td>
                      <td class="px-4 py-3 text-gray-900">{{ fuel_load.liters_added|floatformat:2 }} L</td>
                      <td class="px-4 py-3 text-gray-900">$ {{ fuel_load.payment_amount|floatformat:2 }}</td>
                      <td class="px-4 py-3 text-gray-700">{{ fuel_load.invoice_number }}</td>
                      <td class="px-4 py-3 text-gray-700">{{ fuel_load.driver_name }}</td>
                      <td class="px-4 py-3 text-gray-700">{{ fuel_load.license_plate }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}
      {% else %}
        <div class="mt-6 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-6 text-center">
          <p class="text-sm text-gray-600">Aún no se han registrado inventarios de combustible para esta sucursal.</p>
        </div>
      {% endif %}
    </section>

    <section class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Inventario de productos</h2>
          <p class="mt-1 text-sm text-gray-600">Controla los productos registrados en la sucursal y los ingresos realizados durante el turno.</p>
        </div>
        <div class="flex flex-wrap items-center gap-2 sm:flex-nowrap">
          {% if is_common_attendant %}
            <span
              class="inline-flex items-center whitespace-nowrap rounded-md border border-gray-200 px-4 py-2 text-sm font-semibold text-gray-400 bg-gray-100 cursor-not-allowed"
              aria-disabled="true"
            >
              Administrar productos
            </span>
            <button
              type="button"
              disabled
              aria-disabled="true"
              class="inline-flex items-center whitespace-nowrap rounded-md bg-indigo-200 px-4 py-2 text-sm font-semibold text-gray-500 shadow-sm cursor-not-allowed"
            >
              Registrar ingreso
            </button>
          {% else %}
            <a
              href="{% url 'sucursal_product_create' branch.pk %}"
              class="inline-flex items-center whitespace-nowrap rounded-md border border-gray-200 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50"
            >
              Administrar productos
            </a>
            <button
              type="button"
              class="inline-flex items-center whitespace-nowrap rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
              @click="openModal = 'product-load'"
            >
              Registrar ingreso
            </button>
          {% endif %}
        </div>
      </div>

      {% if branch_products %}
        <div class="mt-6 overflow-hidden rounded-lg border border-gray-200">
          <table class="min-w-full w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                <th scope="col" class="px-4 py-3">Producto</th>
                <th scope="col" class="px-4 py-3">Fecha de llegada</th>
                <th scope="col" class="px-4 py-3">Número de lote</th>
                <th scope="col" class="px-4 py-3 text-right">Cantidad disponible</th>
                <th scope="col" class="px-4 py-3 text-right">Ingresado en turno</th>
                <th scope="col" class="px-4 py-3 text-right">Valor</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white text-sm">
              {% for product in branch_products %}
                <tr>
                  <td class="px-4 py-3 font-medium text-gray-900">{{ product.product_type }}</td>
                  <td class="px-4 py-3 text-gray-700">{{ product.arrival_date|date:"d/m/Y" }}</td>
                  <td class="px-4 py-3 text-gray-700">{{ product.batch_number }}</td>
                  <td class="px-4 py-3 text-right text-gray-900">{{ product.quantity }}</td>
                  <td class="px-4 py-3 text-right text-gray-700">{{ product.session_added_quantity|default:0 }}</td>
                  <td class="px-4 py-3 text-right text-gray-900">$ {{ product.value|floatformat:2 }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if product_loads %}
          <div class="mt-8">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Historial de ingresos</h3>
            <div class="mt-3 overflow-hidden rounded-lg border border-gray-200">
              <table class="min-w-full w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                    <th scope="col" class="px-4 py-3">Fecha</th>
                    <th scope="col" class="px-4 py-3">Producto</th>
                    <th scope="col" class="px-4 py-3 text-right">Cantidad</th>
                    <th scope="col" class="px-4 py-3 text-right">Valor pagado</th>
                    <th scope="col" class="px-4 py-3">Registrado por</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white text-sm">
                  {% for product_load in product_loads %}
                    <tr>
                      <td class="px-4 py-3 text-gray-700">{{ product_load.date|date:"d/m/Y" }}</td>
                      <td class="px-4 py-3 font-medium text-gray-900">{{ product_load.product.product_type }}</td>
                      <td class="px-4 py-3 text-right text-gray-900">{{ product_load.quantity_added }}</td>
                      <td class="px-4 py-3 text-right text-gray-900">$ {{ product_load.payment_amount|floatformat:2 }}</td>
                      <td class="px-4 py-3 text-gray-700">
                        {{ product_load.responsible.user_FK.get_full_name|default:product_load.responsible.user_FK.username }}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}

        {% if product_sales %}
          <div class="mt-8">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Historial de ventas</h3>
            <div class="mt-3 overflow-hidden rounded-lg border border-gray-200">
              <table class="min-w-full w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                    <th scope="col" class="px-4 py-3">Fecha</th>
                    <th scope="col" class="px-4 py-3">Productos vendidos</th>
                    <th scope="col" class="px-4 py-3 text-right">Valor de venta</th>
                    <th scope="col" class="px-4 py-3">Registrado por</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white text-sm">
                  {% for sale in product_sales %}
                    <tr>
                      <td class="px-4 py-3 text-gray-700">{{ sale.sold_at|date:"d/m/Y H:i" }}</td>
                      <td class="px-4 py-3 text-gray-700">
                        <ul class="list-disc space-y-1 pl-4">
                          {% for item in sale.items.all %}
                            <li>
                              <span class="font-medium text-gray-900">{{ item.product.product_type }}</span>
                              <span class="text-gray-600">- {{ item.quantity }} u.</span>
                            </li>
                          {% empty %}
                            <li class="text-gray-500">Sin productos registrados</li>
                          {% endfor %}
                        </ul>
                      </td>
                      <td class="px-4 py-3 text-right text-gray-900">$ {{ sale.total_value|floatformat:2 }}</td>
                      <td class="px-4 py-3 text-gray-700">
                        {{ sale.responsible.user_FK.get_full_name|default:sale.responsible.user_FK.username }}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}
      {% else %}
        <div class="mt-6 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-6 text-center">
          <p class="text-sm text-gray-600">Aún no se han registrado productos para esta sucursal.</p>
        </div>
      {% endif %}
    </section>

    <div
      x-cloak
      x-show="openModal === 'product-load'"
      x-transition.opacity
      class="fixed inset-0 z-50 flex items-stretch justify-center bg-gray-900/80 p-4 sm:items-center"
      style="margin-top: 0%;"
      @click.self="openModal = null"
    >
      <div
        class="w-full max-w-xl overflow-y-auto rounded-none bg-white p-6 shadow-2xl sm:max-h-[calc(100vh-3rem)] sm:rounded-xl"
        @click.away="openModal = null"
      >
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-lg font-semibold text-gray-900">Registrar ingreso de productos</h3>
          <p class="mt-1 text-sm text-gray-500">Añade la cantidad recibida de un producto durante este servicio.</p>
        </div>
        <button type="button" class="rounded-md p-1 text-gray-400 hover:text-gray-600" @click="openModal = null">
          <span class="sr-only">Cerrar</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>

      <form method="post" action="{% url 'service_session_detail' service_session.pk %}" class="mt-6 space-y-6">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="product-load" />

        {% if product_load_form.non_field_errors %}
          <div class="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-700">
            {% for error in product_load_form.non_field_errors %}
              <p>{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}

        <div class="grid gap-4 sm:grid-cols-2">
          <div class="sm:col-span-2">
            <label for="{{ product_load_form.product.id_for_label }}" class="block text-sm font-medium text-gray-700">Producto</label>
            {{ product_load_form.product }}
            {% if product_load_form.product.errors %}
              <p class="mt-1 text-sm text-red-600">{{ product_load_form.product.errors|striptags }}</p>
            {% endif %}
          </div>
          <div>
            <label for="{{ product_load_form.quantity_added.id_for_label }}" class="block text-sm font-medium text-gray-700">Cantidad ingresada</label>
            {{ product_load_form.quantity_added }}
            {% if product_load_form.quantity_added.errors %}
              <p class="mt-1 text-sm text-red-600">{{ product_load_form.quantity_added.errors|striptags }}</p>
            {% endif %}
          </div>
          <div>
            <label for="{{ product_load_form.payment_amount.id_for_label }}" class="block text-sm font-medium text-gray-700">Valor pagado</label>
            {{ product_load_form.payment_amount }}
            {% if product_load_form.payment_amount.errors %}
              <p class="mt-1 text-sm text-red-600">{{ product_load_form.payment_amount.errors|striptags }}</p>
            {% endif %}
          </div>
          <div>
            <span class="block text-sm font-medium text-gray-700">Responsable</span>
            {% if product_load_responsible %}
              <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">
                {{ product_load_responsible.user_FK.get_full_name|default:product_load_responsible.user_FK.username }}
              </p>
            {% else %}
              <p class="mt-2 rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-700">
                No hay un encargado asignado al turno.
              </p>
            {% endif %}
          </div>
          <div>
            <span class="block text-sm font-medium text-gray-700">Fecha</span>
            <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">{{ service_date|date:"d \d\e F \d\e Y" }}</p>
          </div>
        </div>

        <div class="flex flex-wrap items-center justify-end gap-3">
          <button
            type="button"
            class="inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
            @click="openModal = null"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="inline-flex items-center rounded-md bg-gradient-to-br px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
          >
            Registrar ingreso
          </button>
        </div>
      </form>
      </div>
    </div>

    <div
      x-cloak
      x-show="openModal === 'fuel-load'"
      x-transition.opacity
      class="fixed inset-0 z-50 flex justify-center bg-gray-900/80 p-4 sm:items-center"
      @click.self="openModal = null" 
      style="margin-top: 0;"
    >
      <div
        class="w-full max-w-2xl overflow-y-auto rounded-none bg-white p-6 py-2 sm:max-h-[calc(100vh-3rem)] sm:rounded-xl"
        @click.away="openModal = null"
      >
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-lg font-semibold text-gray-900">Registrar carga de combustible</h3>
          <p class="mt-1 text-sm text-gray-500">Ingresa la información de la carga realizada durante el servicio.</p>
        </div>
        <button type="button" class="rounded-md p-1 text-gray-400 hover:text-gray-600" @click="openModal = null">
          <span class="sr-only">Cerrar</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>

      <form method="post" action="{% url 'service_session_detail' service_session.pk %}" class="mt-6 space-y-6">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="fuel-load" />
        {{ fuel_load_form.responsible }}
        {{ fuel_load_form.date }}

        {% if fuel_load_form.non_field_errors %}
          <div class="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-700">
            {% for error in fuel_load_form.non_field_errors %}
              <p>{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}

        <div class="grid gap-4 sm:grid-cols-2">
          <div class="sm:col-span-2">
            <label for="{{ fuel_load_form.inventory.id_for_label }}" class="block text-sm font-medium text-gray-700">Tanque de combustible</label>
            {{ fuel_load_form.inventory }}
            {% if fuel_load_form.inventory.errors %}
              <p class="mt-1 text-sm text-red-600">{{ fuel_load_form.inventory.errors|striptags }}</p>
            {% endif %}
          </div>
          <div>
            <label for="{{ fuel_load_form.liters_added.id_for_label }}" class="block text-sm font-medium text-gray-700">Litros a cargar</label>
            {{ fuel_load_form.liters_added }}
            {% if fuel_load_form.liters_added.errors %}
              <p class="mt-1 text-sm text-red-600">{{ fuel_load_form.liters_added.errors|striptags }}</p>
            {% endif %}
          </div>
          <div>
            <label for="{{ fuel_load_form.payment_amount.id_for_label }}" class="block text-sm font-medium text-gray-700">Valor pagado</label>
            {{ fuel_load_form.payment_amount }}
            {% if fuel_load_form.payment_amount.errors %}
              <p class="mt-1 text-sm text-red-600">{{ fuel_load_form.payment_amount.errors|striptags }}</p>
            {% endif %}
          </div>
          <div>
            <label for="{{ fuel_load_form.invoice_number.id_for_label }}" class="block text-sm font-medium text-gray-700">Número de factura</label>
            {{ fuel_load_form.invoice_number }}
            {% if fuel_load_form.invoice_number.errors %}
              <p class="mt-1 text-sm text-red-600">{{ fuel_load_form.invoice_number.errors|striptags }}</p>
            {% endif %}
          </div>
          <div>
            <span class="block text-sm font-medium text-gray-700">Responsable</span>
            {% if fuel_responsible %}
              <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">
                {{ fuel_responsible.user_FK.get_full_name|default:fuel_responsible.user_FK.username }}
              </p>
            {% else %}
              <p class="mt-2 rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-700">
                No hay un encargado asignado al turno.
              </p>
            {% endif %}
          </div>
          <div>
            <label for="{{ fuel_load_form.driver_name.id_for_label }}" class="block text-sm font-medium text-gray-700">Nombre del chofer</label>
            {{ fuel_load_form.driver_name }}
            {% if fuel_load_form.driver_name.errors %}
              <p class="mt-1 text-sm text-red-600">{{ fuel_load_form.driver_name.errors|striptags }}</p>
            {% endif %}
          </div>
          <div>
            <label for="{{ fuel_load_form.license_plate.id_for_label }}" class="block text-sm font-medium text-gray-700">Patente</label>
            {{ fuel_load_form.license_plate }}
            {% if fuel_load_form.license_plate.errors %}
              <p class="mt-1 text-sm text-red-600">{{ fuel_load_form.license_plate.errors|striptags }}</p>
            {% endif %}
          </div>
          <div>
            <span class="block text-sm font-medium text-gray-700">Fecha</span>
            <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">{{ service_date|date:"d \d\e F \d\e Y" }}</p>
          </div>
        </div>

        <div class="flex flex-wrap items-center justify-end gap-3">
          <button
            type="button"
            class="inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
            @click="openModal = null"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="inline-flex items-center rounded-md bg-gradient-to-br px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
          >
            Guardar carga
          </button>
        </div>
      </form>
    </div>
  </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
  <script defer src="{% static 'js/tabs.js' %}"></script>
  
  
{% endblock javascript %}