{% extends 'components/Layout/base_pages.html' %}
{% load static %}

{% block content_pages %}
<div class="mx-auto max-w-6xl space-y-8">
  <section class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <p class="text-sm font-semibold uppercase tracking-wide text-indigo-600">Servicio en ejecución</p>
        <h1 class="mt-1 text-3xl font-bold text-gray-900">
          Turno {{ shift.code }} · {{ shift.sucursal.name }}
        </h1>
        <p class="mt-2 text-sm text-gray-600">
          Iniciado el {{ service_session.started_at|date:"d \d\e F \d\e Y" }} a las {{ service_session.started_at|date:"H:i" }} hrs.
        </p>
      </div>
      <div class="rounded-lg border border-indigo-100 bg-indigo-50 px-4 py-3 text-sm text-indigo-700 shadow-sm">
        <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600">Presupuesto inicial</p>
        <p class="mt-1 text-2xl font-bold text-indigo-900">
          $ {{ service_session.initial_budget|floatformat:2 }}
        </p>
        <p class="mt-2 text-xs text-indigo-700">Monedas: $ {{ service_session.coins_amount|floatformat:2 }} · Efectivo: $ {{ service_session.cash_amount|floatformat:2 }}</p>
      </div>
    </div>
  </section>

  <section class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <h2 class="text-lg font-semibold text-gray-900">Equipo asignado</h2>
        <p class="mt-1 text-sm text-gray-600">Encargado y bomberos disponibles para este servicio.</p>
      </div>
    </div>
    <div class="mt-6 grid gap-6 lg:grid-cols-2">
      <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
        <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Encargado del turno</h3>
        {% with manager=shift.manager %}
          {% if manager %}
            <p class="mt-3 text-base font-semibold text-gray-900">{{ manager.user_FK.get_full_name|default:manager.user_FK.username }}</p>
            {% if manager.position_FK %}
              <p class="text-sm text-gray-600">{{ manager.position_FK.user_position }}</p>
            {% endif %}
          {% else %}
            <p class="mt-3 text-sm text-gray-600">No hay un encargado asignado al turno.</p>
          {% endif %}
        {% endwith %}
      </div>
      <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
        <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Bomberos asignados</h3>
        {% if attendants %}
          <ul class="mt-3 space-y-2">
            {% for attendant in attendants %}
              <li class="flex items-center justify-between gap-3 rounded-md border border-gray-100 bg-white px-3 py-2 text-sm text-gray-700">
                <span class="font-medium text-gray-900">{{ attendant.user_FK.get_full_name|default:attendant.user_FK.username }}</span>
                {% if attendant.position_FK %}
                  <span class="text-xs text-gray-500">{{ attendant.position_FK.user_position }}</span>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="mt-3 text-sm text-gray-600">No hay bomberos asignados a este servicio.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <div class="border-b border-gray-200">
    <nav class="-mb-px flex flex-wrap gap-4" aria-label="Tabs">
      <button
        type="button"
        data-tab-target="tab-caja"
        data-tab-group="service-session"
        class="whitespace-nowrap border-b-2 border-indigo-500 px-1 py-3 text-sm font-medium text-indigo-600"
        aria-controls="tab-caja"
        aria-selected="true"
      >Caja</button>
      <button
        type="button"
        data-tab-target="tab-inventario"
        data-tab-group="service-session"
        class="whitespace-nowrap border-b-2 border-transparent px-1 py-3 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
        aria-controls="tab-inventario"
        aria-selected="false"
      >Inventario</button>
    </nav>
  </div>

  <div id="tab-caja" class="tab-content mt-8 space-y-6">
    <section class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Resumen de caja</h2>
          <p class="mt-1 text-sm text-gray-600">Controla el dinero disponible al inicio de este servicio.</p>
        </div>
      </div>
      <dl class="mt-6 grid grid-cols-1 gap-6 sm:grid-cols-3">
        <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
          <dt class="text-sm font-medium text-gray-500">Monedas</dt>
          <dd class="mt-2 text-2xl font-semibold text-gray-900">$ {{ service_session.coins_amount|floatformat:2 }}</dd>
        </div>
        <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
          <dt class="text-sm font-medium text-gray-500">Efectivo</dt>
          <dd class="mt-2 text-2xl font-semibold text-gray-900">$ {{ service_session.cash_amount|floatformat:2 }}</dd>
        </div>
        <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
          <dt class="text-sm font-medium text-gray-500">Total disponible</dt>
          <dd class="mt-2 text-2xl font-semibold text-gray-900">$ {{ service_session.initial_budget|floatformat:2 }}</dd>
        </div>
      </dl>
    </section>
  </div>

  <div
    id="tab-inventario"
    class="tab-content mt-8 space-y-6 hidden"
    x-data="{ openModal: null }"
    @keydown.escape.window="openModal = null"
  >
    <section class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Inventario del servicio</h2>
          <p class="mt-1 text-sm text-gray-600">Aquí podrás registrar y revisar el inventario utilizado durante el servicio.</p>
        </div>
        {% if fuel_inventories %}
          <button
            type="button"
            class="inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
            @click="openModal = 'fuel-load'"
          >
            Agregar combustible
          </button>
        {% endif %}
      </div>

      {% if fuel_inventories %}
        <div class="mt-6 overflow-hidden rounded-lg border border-gray-200">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                <th scope="col" class="px-4 py-3">Tanque</th>
                <th scope="col" class="px-4 py-3">Tipo de combustible</th>
                <th scope="col" class="px-4 py-3 text-right">Capacidad total (L)</th>
                <th scope="col" class="px-4 py-3 text-right">Cantidad actual (L)</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white text-sm">
              {% for inventory in fuel_inventories %}
                <tr>
                  <td class="px-4 py-3 font-medium text-gray-900">{{ inventory.code }}</td>
                  <td class="px-4 py-3 text-gray-700">{{ inventory.fuel_type }}</td>
                  <td class="px-4 py-3 text-right text-gray-700">{{ inventory.capacity|floatformat:2 }}</td>
                  <td class="px-4 py-3 text-right text-gray-900">{{ inventory.liters|floatformat:2 }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if fuel_loads %}
          <div class="mt-8">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Historial de cargas</h3>
            <div class="mt-3 overflow-hidden rounded-lg border border-gray-200">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr class="text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                    <th scope="col" class="px-4 py-3">Fecha</th>
                    <th scope="col" class="px-4 py-3">Tanque</th>
                    <th scope="col" class="px-4 py-3">Litros cargados</th>
                    <th scope="col" class="px-4 py-3">Factura</th>
                    <th scope="col" class="px-4 py-3">Chofer</th>
                    <th scope="col" class="px-4 py-3">Patente</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white text-sm">
                  {% for fuel_load in fuel_loads %}
                    <tr>
                      <td class="px-4 py-3 text-gray-700">{{ fuel_load.date|date:"d/m/Y" }}</td>
                      <td class="px-4 py-3 font-medium text-gray-900">{{ fuel_load.inventory.code }}</td>
                      <td class="px-4 py-3 text-gray-900">{{ fuel_load.liters_added|floatformat:2 }} L</td>
                      <td class="px-4 py-3 text-gray-700">{{ fuel_load.invoice_number }}</td>
                      <td class="px-4 py-3 text-gray-700">{{ fuel_load.driver_name }}</td>
                      <td class="px-4 py-3 text-gray-700">{{ fuel_load.license_plate }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}
      {% else %}
        <div class="mt-6 rounded-lg border border-dashed border-gray-300 bg-gray-50 p-6 text-center">
          <p class="text-sm text-gray-600">Aún no se han registrado inventarios de combustible para esta sucursal.</p>
        </div>
      {% endif %}
    </section>

    <div
      x-cloak
      x-show="openModal === 'fuel-load'"
      x-transition.opacity
      class="fixed inset-0 z-50 flex items-stretch justify-center bg-gray-900/80 p-4 sm:items-center"
      @click.self="openModal = null"
    >
      <div
        class="w-full max-w-2xl overflow-y-auto rounded-none bg-white p-6 shadow-2xl sm:max-h-[calc(100vh-3rem)] sm:rounded-xl"
        @click.away="openModal = null"
      >
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-900">Registrar carga de combustible</h3>
            <p class="mt-1 text-sm text-gray-500">Ingresa la información de la carga realizada durante el servicio.</p>
          </div>
          <button type="button" class="rounded-md p-1 text-gray-400 hover:text-gray-600" @click="openModal = null">
            <span class="sr-only">Cerrar</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>

        <form method="post" action="{% url 'service_session_detail' service_session.pk %}" class="mt-6 space-y-6">
          {% csrf_token %}
          {{ fuel_load_form.responsible }}
          {{ fuel_load_form.date }}

          {% if fuel_load_form.non_field_errors %}
            <div class="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-700">
              {% for error in fuel_load_form.non_field_errors %}
                <p>{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}

          <div class="grid gap-4 sm:grid-cols-2">
            <div class="sm:col-span-2">
              <label for="{{ fuel_load_form.inventory.id_for_label }}" class="block text-sm font-medium text-gray-700">Tanque de combustible</label>
              {{ fuel_load_form.inventory }}
              {% if fuel_load_form.inventory.errors %}
                <p class="mt-1 text-sm text-red-600">{{ fuel_load_form.inventory.errors|striptags }}</p>
              {% endif %}
            </div>
            <div>
              <label for="{{ fuel_load_form.liters_added.id_for_label }}" class="block text-sm font-medium text-gray-700">Litros a cargar</label>
              {{ fuel_load_form.liters_added }}
              {% if fuel_load_form.liters_added.errors %}
                <p class="mt-1 text-sm text-red-600">{{ fuel_load_form.liters_added.errors|striptags }}</p>
              {% endif %}
            </div>
            <div>
              <label for="{{ fuel_load_form.invoice_number.id_for_label }}" class="block text-sm font-medium text-gray-700">Número de factura</label>
              {{ fuel_load_form.invoice_number }}
              {% if fuel_load_form.invoice_number.errors %}
                <p class="mt-1 text-sm text-red-600">{{ fuel_load_form.invoice_number.errors|striptags }}</p>
              {% endif %}
            </div>
            <div>
              <span class="block text-sm font-medium text-gray-700">Responsable</span>
              {% if fuel_responsible %}
                <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">
                  {{ fuel_responsible.user_FK.get_full_name|default:fuel_responsible.user_FK.username }}
                </p>
              {% else %}
                <p class="mt-2 rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-700">
                  No hay un encargado asignado al turno.
                </p>
              {% endif %}
            </div>
            <div>
              <label for="{{ fuel_load_form.driver_name.id_for_label }}" class="block text-sm font-medium text-gray-700">Nombre del chofer</label>
              {{ fuel_load_form.driver_name }}
              {% if fuel_load_form.driver_name.errors %}
                <p class="mt-1 text-sm text-red-600">{{ fuel_load_form.driver_name.errors|striptags }}</p>
              {% endif %}
            </div>
            <div>
              <label for="{{ fuel_load_form.license_plate.id_for_label }}" class="block text-sm font-medium text-gray-700">Patente</label>
              {{ fuel_load_form.license_plate }}
              {% if fuel_load_form.license_plate.errors %}
                <p class="mt-1 text-sm text-red-600">{{ fuel_load_form.license_plate.errors|striptags }}</p>
              {% endif %}
            </div>
            <div>
              <span class="block text-sm font-medium text-gray-700">Fecha</span>
              <p class="mt-2 rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-700">{{ service_date|date:"d \d\e F \d\e Y" }}</p>
            </div>
          </div>

          <div class="flex flex-wrap items-center justify-end gap-3">
            <button
              type="button"
              class="inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
              @click="openModal = null"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
            >
              Guardar carga
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
  <script defer src="{% static 'js/tabs.js' %}"></script>
{% endblock javascript %}