{% extends "components/Layout/base_extendido.html" %}
{% load static %}

{% block content_main %}
<div class="mx-auto max-w-6xl space-y-8">
  <div class="flex flex-col gap-4 border-b border-gray-200 pb-6 md:flex-row md:items-center md:justify-between">
    <div>
      <p class="text-sm font-semibold uppercase tracking-wide text-indigo-600">Gestión de turnos</p>
      <h1 class="mt-1 text-3xl font-bold text-gray-900">Inicio de servicio</h1>
      <p class="mt-2 text-sm text-gray-600">
        Configura los bomberos que participarán en el turno seleccionado y registra el presupuesto inicial del servicio.
      </p>
    </div>
    <div class="rounded-lg border border-indigo-100 bg-indigo-50 px-4 py-3 text-sm text-indigo-700 shadow-sm">
      <p class="font-semibold text-indigo-900">{{ current_datetime|date:"d \d\e F \d\e Y" }}</p>
      <p class="mt-1 text-xs uppercase tracking-wide text-indigo-600">Hora actual: {{ current_datetime|date:"H:i" }}</p>
    </div>
  </div>

  {% if not has_shifts %}
    <div class="rounded-lg border border-amber-200 bg-amber-50 px-6 py-5 text-amber-800">
      <h2 class="text-base font-semibold text-amber-900">No hay turnos configurados</h2>
      <p class="mt-2 text-sm text-amber-800">
        Debes crear al menos un turno para alguna sucursal antes de iniciar un servicio.
        Puedes hacerlo desde la sección de <strong>Sucursales</strong>.
      </p>
    </div>
  {% else %}
    <form method="post" class="space-y-8" novalidate>
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="rounded-md border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
          <ul class="list-disc space-y-1 pl-5">
            {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <section class="grid gap-8 lg:grid-cols-2">
        <div class="space-y-6">
          <div>
            <label for="{{ form.shift.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.shift.label }}</label>
            {{ form.shift }}
            {% if form.shift.errors %}
              <ul class="mt-2 space-y-1 text-sm text-red-600">
                {% for error in form.shift.errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            {% endif %}
            <p class="mt-2 text-xs text-gray-500">Selecciona el turno que iniciará servicio. El listado de bomberos se actualizará automáticamente.</p>
          </div>

          <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm">
            <div class="flex items-start justify-between gap-4">
              <div>
                <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Turno seleccionado</p>
                {% if selected_shift %}
                  <h2 class="mt-1 text-lg font-semibold text-gray-900">{{ selected_shift.code }} · {{ selected_shift.sucursal.name }}</h2>
                  <p class="mt-2 inline-flex items-center gap-2 rounded-full bg-gray-100 px-3 py-1 text-xs font-medium text-gray-700">
                    {{ selected_shift.start_time|time:"H:i" }} – {{ selected_shift.end_time|time:"H:i" }}
                  </p>
                {% else %}
                  <p class="mt-2 text-sm text-gray-600">Selecciona un turno para ver los detalles.</p>
                {% endif %}
              </div>
            </div>

            {% if selected_shift %}
              <div class="mt-5 border-t border-gray-200 pt-5">
                <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Encargado del turno</p>
                <div class="mt-2 text-sm text-gray-700">
                  {% with manager=selected_shift.manager %}
                    <p class="font-semibold text-gray-900">{{ manager.user_FK.get_full_name|default:manager.user_FK.username }}</p>
                    {% if manager.position_FK %}
                      <p class="text-xs text-gray-500">{{ manager.position_FK.user_position }}</p>
                    {% endif %}
                  {% endwith %}
                </div>
              </div>

              <div class="mt-5 border-t border-gray-200 pt-5">
                <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Bomberos actualmente asignados</p>
                {% if current_attendants %}
                  <ul class="mt-3 space-y-2 text-sm text-gray-700">
                    {% for attendant in current_attendants %}
                      <li class="flex items-center justify-between gap-3 rounded-md border border-gray-100 bg-gray-50 px-3 py-2">
                        <span class="font-medium text-gray-900">{{ attendant.user_FK.get_full_name|default:attendant.user_FK.username }}</span>
                        {% if attendant.position_FK %}
                          <span class="text-xs text-gray-500">{{ attendant.position_FK.user_position }}</span>
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="mt-2 text-sm text-gray-600">Este turno aún no tiene bomberos asignados.</p>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>

        <div class="space-y-6">
          <div>
            <label for="{{ form.attendants.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.attendants.label }}</label>
            {{ form.attendants }}
            {% if form.attendants.help_text %}
              <p class="mt-2 text-xs text-gray-500">{{ form.attendants.help_text }}</p>
            {% endif %}
            {% if form.attendants.errors %}
              <ul class="mt-2 space-y-1 text-sm text-red-600">
                {% for error in form.attendants.errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            {% endif %}
            <p class="mt-2 text-xs text-gray-500">Los bomberos disponibles para reemplazo son quienes no tienen turnos asociados actualmente.</p>
            {% if available_replacements %}
              <div class="mt-3 rounded-md border border-dashed border-indigo-200 bg-indigo-50 px-4 py-3 text-xs text-indigo-700">
                <p class="font-semibold text-indigo-900">Bomberos disponibles para reemplazo</p>
                <ul class="mt-2 space-y-1">
                  {% for profile in available_replacements %}
                    <li>{{ profile.user_FK.get_full_name|default:profile.user_FK.username }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </div>

          <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm">
            <h2 class="text-lg font-semibold text-gray-900">Presupuesto inicial</h2>
            <p class="mt-1 text-sm text-gray-600">Registra el dinero disponible al inicio del turno. El total se calcula automáticamente.</p>
            <div class="mt-4 grid gap-4 sm:grid-cols-2">
              <div>
                <label for="{{ form.coins_amount.id_for_label }}" class="block text-sm font-medium text-gray-700">Monedas</label>
                {{ form.coins_amount }}
                {% if form.coins_amount.help_text %}
                  <p class="mt-2 text-xs text-gray-500">{{ form.coins_amount.help_text }}</p>
                {% endif %}
                {% if form.coins_amount.errors %}
                  <ul class="mt-2 space-y-1 text-sm text-red-600">
                    {% for error in form.coins_amount.errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>
              <div>
                <label for="{{ form.cash_amount.id_for_label }}" class="block text-sm font-medium text-gray-700">Efectivo</label>
                {{ form.cash_amount }}
                {% if form.cash_amount.help_text %}
                  <p class="mt-2 text-xs text-gray-500">{{ form.cash_amount.help_text }}</p>
                {% endif %}
                {% if form.cash_amount.errors %}
                  <ul class="mt-2 space-y-1 text-sm text-red-600">
                    {% for error in form.cash_amount.errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>
            </div>
            <div class="mt-6 rounded-md border border-indigo-100 bg-indigo-50 px-4 py-3">
              <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600">Presupuesto inicial del turno</p>
              <p id="initial-budget-value" class="mt-1 text-2xl font-bold text-indigo-900">$0</p>
            </div>
          </div>
        </div>
      </section>

      <div class="flex items-center justify-end gap-3 border-t border-gray-200 pt-6">
        <a href="{% url 'Home' %}" class="inline-flex items-center rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100">Cancelar</a>
        <button type="submit" class="inline-flex items-center rounded-md bg-gradient-to-br from-indigo-500 to-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:from-indigo-600 hover:to-blue-700">Iniciar servicio</button>
      </div>
    </form>
  {% endif %}
</div>

<script>
  (function() {
    const shiftSelect = document.getElementById("id_shift");
    if (shiftSelect) {
      shiftSelect.addEventListener("change", function() {
        const selectedShift = this.value;
        const url = new URL(window.location.href);
        if (selectedShift) {
          url.searchParams.set("shift", selectedShift);
        } else {
          url.searchParams.delete("shift");
        }
        window.location.href = url.toString();
      });
    }

    const coinsInput = document.getElementById("id_coins_amount");
    const cashInput = document.getElementById("id_cash_amount");
    const totalLabel = document.getElementById("initial-budget-value");

    function formatCurrency(value) {
      return new Intl.NumberFormat("es-CL", { style: "currency", currency: "CLP", minimumFractionDigits: 0 }).format(value);
    }

    function parseValue(input) {
      if (!input) {
        return 0;
      }
      const value = parseFloat(input.value.replace(',', '.'));
      return isNaN(value) ? 0 : value;
    }

    function updateBudget() {
      const total = parseValue(coinsInput) + parseValue(cashInput);
      totalLabel.textContent = formatCurrency(total);
    }

    if (coinsInput) {
      coinsInput.addEventListener("input", updateBudget);
      coinsInput.addEventListener("change", updateBudget);
    }
    if (cashInput) {
      cashInput.addEventListener("input", updateBudget);
      cashInput.addEventListener("change", updateBudget);
    }

    updateBudget();
  })();
</script>
{% endblock content_main %}